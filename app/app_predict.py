import streamlit as st
import pandas as pd
import plotly.express as px
from src.predict import predict_churn

def run_predict():
    st.title("ğŸ”® KeepTune AI : ì´íƒˆ ë°©ì–´ ì‹œë®¬ë ˆì´í„°")
    st.markdown("##### **í•˜ì´ë¸Œë¦¬ë“œ AI ëª¨ë¸ ê¸°ë°˜ ê¸°ì—… ë§ì¶¤í˜• ì „ëµ ì§„ë‹¨**")
    st.markdown("---")

    # 1. ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬
    if 'predict_done' not in st.session_state:
        st.session_state.predict_done = False
    if 'result_data' not in st.session_state:
        st.session_state.result_data = None

    # 2. ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • ì„¹ì…˜
    with st.container():
        st.subheader("ğŸ‘¤ ì‹œë®¬ë ˆì´ì…˜ ëŒ€ìƒ ì„¤ì •")
        col1, col2 = st.columns(2)
        
        with col1:
            # ìë™ ê°±ì‹  ì—¬ë¶€
            auto_label = st.radio("ğŸ’³ ì •ê¸° ê²°ì œ(ìë™ ê°±ì‹ ) ì„¤ì •", ["í™œì„± (êµ¬ë… ì¤‘)", "í•´ì§€ (ë§Œë£Œ ì˜ˆì •)"], horizontal=True)
            auto_renew = 1.0 if "í™œì„±" in auto_label else 0.0
            
            # ì²­ì·¨ ì‹œê°„ ì„¤ì • ë° ì§ê´€ì  ê°€ì´ë“œ
            total_mins = st.slider("ğŸ§ ì¼í‰ê·  ë…¸ë˜ ì²­ì·¨ ì‹œê°„ (ë¶„)", 0, 720, 30, step=1)
            if total_mins == 0:
                st.caption("ğŸ‘» **Status: Inactive** - ì ‘ì† ê¸°ë¡ì´ ì—†ëŠ” ì´íƒˆ ê³ ìœ„í—˜êµ°ì…ë‹ˆë‹¤.")
            elif total_mins < 30:
                st.caption("ğŸ“‰ **Status: Light User** - ì„œë¹„ìŠ¤ ì•ˆì°©ì„ ìœ„í•œ í™œì„±í™” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.")
            elif total_mins < 180:
                st.caption("âœ… **Status: Active** - ì•ˆì •ì ì¸ ì´ìš© íŒ¨í„´ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.")
            else:
                st.caption("ğŸ”¥ **Status: Heavy User** - ìš°ë¦¬ ì„œë¹„ìŠ¤ì˜ í•µì‹¬ íŒ¬ì¸µ(Loyal)ì…ë‹ˆë‹¤.")
            
            total_secs = float(total_mins * 60)
            
        with col2:
            # í•´ì§€ ì‹œë„ ë¹„ìœ¨ (ì‹¬ë¦¬ì  ë‹¨ê³„)
            cancel_rate = st.slider(
                "âš ï¸ ì„œë¹„ìŠ¤ ì´íƒˆ ì§•í›„ (ê³¼ê±° í•´ì§€ ì‹œë„ í™•ë¥ )", 
                0.0, 1.0, 0.1, step=0.01,
                help="ê³¼ê±° í•´ì§€ í˜ì´ì§€ ë°©ë¬¸ì´ë‚˜ í˜œíƒ íŒì—… ë…¸ì¶œ ë“± ì´íƒˆ ê³ ë¯¼ í”ì ì„ ìˆ˜ì¹˜í™”í•œ ì§€í‘œì…ë‹ˆë‹¤."
            )
            if cancel_rate < 0.2:
                st.write("ğŸ˜‡ ìœ ì € ì‹¬ë¦¬: **í‰ì˜¨ (ë§Œì¡±í•˜ë©° ì´ìš© ì¤‘)**")
            elif cancel_rate < 0.6:
                st.write("ğŸ¤” ìœ ì € ì‹¬ë¦¬: **ë²ˆë¯¼ (íƒ€ì‚¬ ì„œë¹„ìŠ¤ì™€ ì €ìš¸ì§ˆ ì¤‘)**")
            else:
                st.write("ğŸš¨ ìœ ì € ì‹¬ë¦¬: **ìœ„í—˜ (í•´ì§€ ë²„íŠ¼ í´ë¦­ ì§ì „ ìƒíƒœ)**")

            # ëˆ„ì  ê²°ì œ íšŸìˆ˜ (ìˆ™ë ¨ë„ ë° ë¡œì—´í‹° ë‹¨ê³„)
            txn_cnt = st.slider(
                "ğŸ’° ëˆ„ì  ê²°ì œ íšŸìˆ˜ (íšŒ)", 1, 100, 10, step=1,
                help="ê²°ì œ íšŸìˆ˜ëŠ” ìœ ì €ì˜ 'ì„œë¹„ìŠ¤ ìˆ™ë ¨ë„'ì™€ 'ë¸Œëœë“œ ë¡œì—´í‹°'ë¥¼ ìƒì§•í•©ë‹ˆë‹¤."
            )
            if txn_cnt <= 3:
                st.caption("ğŸŒ± **Stage: Early** - ì„œë¹„ìŠ¤ íƒìƒ‰ê¸°ì´ë©° ì´ˆê¸° ì´íƒˆ ìœ„í—˜ì´ í½ë‹ˆë‹¤.")
            elif txn_cnt <= 12:
                st.caption("ğŸƒ **Stage: Settled** - 1ë…„ ë‚´ì™¸ ì´ìš©ìë¡œ ì•ˆì •ì ì¸ êµ¬ë… ë‹¨ê³„ì…ë‹ˆë‹¤.")
            elif txn_cnt <= 36:
                st.caption("ğŸ’ **Stage: Loyal** - 3ë…„ ì´ìƒ ì´ìš©í•œ í•µì‹¬ ê³ ê°ì´ë‚˜ ê¶Œíƒœê¸°ê°€ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            else:
                st.caption("ğŸ‘‘ **Stage: VIP** - ê°•ë ¥í•œ íŒ¬ë¤ì„ ê°€ì§„ ìµœìƒìœ„ ë“±ê¸‰ ìœ ì €ì…ë‹ˆë‹¤.")

    # 3. ë°ì´í„° ì¡°ë¦½ ë° AI ì§„ë‹¨ (XGBoost & ResNet í•˜ì´ë¸Œë¦¬ë“œ)
    input_data = {
        'is_auto_renew': auto_renew, 
        'total_secs_mean': total_secs, 
        'is_cancel': 1.0 if cancel_rate > 0.5 else 0.0,
        'payment_plan_days': 30.0, 
        'txn_cnt': float(txn_cnt),
        'total_paid': float(txn_cnt) * 30.0, 
        'total_secs_sum': total_secs * float(txn_cnt),
        'auto_renew_rate': auto_renew, 
        'cancel_rate': cancel_rate,
    }

    if st.button("ğŸš€ AI í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ ì§„ë‹¨ ì‹œì‘", use_container_width=True, type="primary"):
        try:
            with st.spinner('AI ë¶„ì„ ì—”ì§„ì´ ìµœì ì˜ ëŒ€ì‘ ì „ëµì„ ë„ì¶œ ì¤‘ì…ë‹ˆë‹¤...'):
                # AI ëª¨ë¸ ì˜ˆì¸¡ í˜¸ì¶œ (ë¶€íŠ¸ìº í”„ì—ì„œ í•™ìŠµí•œ ëª¨ë¸ ê¸°ë°˜)
                p_xgb, p_resnet, _ = predict_churn(input_data)
                
                # ìœ ì € ìˆ™ë ¨ë„(txn_cnt)ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜ ë™ì  ì¡°ì ˆ
                w_xgb, w_resnet = (0.7, 0.3) if txn_cnt >= 5 else (0.3, 0.7)
                final_score = (p_xgb * w_xgb) + (p_resnet * w_resnet)
                
                st.session_state.result_data = {
                    'p_xgb': float(p_xgb), 'p_resnet': float(p_resnet),
                    'final_score': float(final_score), 'w_xgb': w_xgb, 'w_resnet': w_resnet,
                }
                st.session_state.predict_done = True
                st.toast("âœ… ë¶„ì„ ë° ë§ì¶¤ ì „ëµ ë„ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        except Exception as e:
            st.error(f"âš ï¸ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    # 4. ë¶„ì„ ë¦¬í¬íŠ¸ ì¶œë ¥
    if st.session_state.predict_done:
        res = st.session_state.result_data
        risk_score = res['final_score'] * 100

        st.markdown("---")
        st.subheader("ğŸ“Š AI í•˜ì´ë¸Œë¦¬ë“œ ì§„ë‹¨ ë¦¬í¬íŠ¸")
        
        # ìœ„í—˜ ë“±ê¸‰ ë¶„ë¥˜
        if risk_score > 80:
            status, color = "ì´ˆê³ ìœ„í—˜ (Critical)", "red"
        elif risk_score > 40:
            status, color = "ì£¼ì˜êµ° (Warning)", "orange"
        else:
            status, color = "ì•ˆì •ê¶Œ (Stable)", "green"

        st.markdown(f"**ì§„ë‹¨ ê²°ê³¼:** :{color}[**{status}**]")

        m1, m2, m3 = st.columns(3)
        m1.metric("ìµœì¢… ì´íƒˆ ìœ„í—˜ë„", f"{risk_score:.1f}%", delta="Critical" if risk_score > 60 else "Safe", delta_color="inverse")
        m2.metric("í†µê³„ ê¸°ë°˜ ì ìˆ˜ (XGB)", f"{res['p_xgb']*100:.1f}%")
        m3.metric("íŒ¨í„´ ê¸°ë°˜ ì ìˆ˜ (ResNet)", f"{res['p_resnet']*100:.1f}%")

        st.progress(res['final_score'])

        # 5. ì‹œê°í™” ì°¨íŠ¸
        col_c1, col_c2 = st.columns(2)
        with col_c1:
            st.write("**ëª¨ë¸ë³„ ë¶„ì„ ê°€ì¤‘ì¹˜**")
            fig_pie = px.pie(values=[res['w_xgb'], res['w_resnet']], names=['í†µê³„(XGBoost)', 'íŒ¨í„´(ResNet)'], 
                             color_discrete_sequence=['#31ed8c', '#00d4ff'], hole=0.4)
            fig_pie.update_layout(height=280, margin=dict(l=0, r=0, t=20, b=0))
            st.plotly_chart(fig_pie, use_container_width=True)
            
        with col_c2:
            st.write("**ë°ì´í„°ë³„ ìœ„í—˜ ê¸°ì—¬ë„**")
            features = ['ì •ê¸°ê²°ì œ', 'í™œë™ì„±', 'ìˆ™ë ¨ë„', 'ì´íƒˆì´ë ¥']
            impact = [
                35 if auto_renew == 0 else -20, 
                25 if total_mins < 30 else -15,
                15 if txn_cnt > 40 else -5,
                25 if cancel_rate > 0.5 else -10
            ]
            fig_bar = px.bar(x=impact, y=features, orientation='h', color=impact, color_continuous_scale='RdYlGn_r')
            fig_bar.update_layout(height=280, margin=dict(l=0, r=0, t=20, b=0), coloraxis_showscale=False)
            st.plotly_chart(fig_bar, use_container_width=True)

        # ğŸ› ï¸ 6. AI ì „ëµ ì‹¤í–‰ ê³„íš
        st.markdown("---")
        st.subheader("ğŸ› ï¸ AI ì „ëµ ì‹¤í–‰ ê³„íš (ê¸°ì—… ë§ì¶¤í˜• ì œì•ˆ)")
        st.caption("ìœ ì € ì„¸ê·¸ë¨¼íŠ¸ë³„ ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë„ì¶œëœ ë¹„ì¦ˆë‹ˆìŠ¤ ì•¡ì…˜ í”Œëœì…ë‹ˆë‹¤.")

        t1, t2, t3, t4 = st.tabs(["ğŸ’° ìˆ˜ìµì„± ì „ëµ", "ğŸ¨ ê²½í—˜ ê°•í™”", "ğŸ¤ ê³ ê° ì¼€ì–´", "ğŸ“ˆ ì‹¤í–‰ íš¨ê³¼"])

        with t1:
            st.markdown("#### **1. ë§¤ì¶œ ìµœì í™” ë° ê²°ì œ ìœ ì§€ ì „ëµ**")
            if txn_cnt > 36:
                st.markdown("#### **[VIP ê³ ê°] ìµœìƒìœ„ ìœ ì§€(Retention) ì „ëµ**")
                st.write("- **ëª©í‘œ**: 3ë…„+ ì¥ê¸° ê³ ê°ì˜ ì´íƒˆ ë°©ì§€")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ì¥ê¸° ê²°ì œ ê°ì‚¬ ìº í˜ì¸ (ë¶„ê¸°ë³„ 'ê°ì‚¬ ì´ë²¤íŠ¸' ê°œìµœ)")
                st.write("  2ï¸âƒ£ í”„ë¦¬ë¯¸ì—„ ì „ìš© í˜œíƒ (HD ìŒì§ˆ, ë…ì  í”Œë ˆì´ë¦¬ìŠ¤íŠ¸, ìš°ì„  ì§€ì›)")
                st.write("  3ï¸âƒ£ ì»¤ë®¤ë‹ˆí‹° ë¦¬ë” ê¶Œí•œ ë¶€ì—¬ (ë² íƒ€ í…ŒìŠ¤í„°, í”¼ë“œë°± ê·¸ë£¹)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ì´íƒˆë¥  80% ê°ì†Œ, LTV 35% ì¦ëŒ€")
            elif txn_cnt <= 3:
                st.markdown("#### **[ì‹ ê·œ ê³ ê°] ì´ˆê¸° ì •ì°© ë° ì¬ê²°ì œ ìœ ë„**")
                st.write("- **ëª©í‘œ**: ê°€ì… í›„ 3ê°œì›” ë‚´ ì •ê¸° ê²°ì œ ì „í™˜")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ì˜¨ë³´ë”© ë³´ë„ˆìŠ¤ (ì²« ê²°ì œ ì‹œ ì¶”ê°€ 30ì¼ ë¬´ë£Œ)")
                st.write("  2ï¸âƒ£ ì´ˆê¸° 5íšŒ ê²°ì œ ë§ˆì¼ë¦¬ì§€ (ëˆ„ì  ë³´ìƒìœ¼ë¡œ 6ë²ˆì§¸ ê²°ì œ 50% í• ì¸)")
                st.write("  3ï¸âƒ£ ë§ì¶¤ ì¥ë¥´ ì¶”ì²œ (ê°€ì… ì‹œ ì·¨í–¥ ì„¤ë¬¸ ê¸°ë°˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ì‹ ê·œ ì¬ê²°ì œìœ¨ 45% â†’ 68%, ì´íƒˆë¥  50% ê°ì†Œ")
            
            if auto_renew == 0:
                st.error("#### **âš ï¸ [ê¸´ê¸‰] ìë™ ê²°ì œ ë¯¸ì„¤ì • ê³ ê° ì „í™˜ ìº í˜ì¸**")
                st.write("- **ì¤‘ìš”ë„**: ğŸ”´ **CRITICAL** (ë¯¸ì„¤ì • ê³ ê°ì˜ ì´íƒˆë¥ : í‰ê· ì˜ 2ë°°)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ì¦‰ì‹œ ì¸ì„¼í‹°ë¸Œ (ìë™ ê²°ì œ ì „í™˜ ì‹œ '6ê°œì›”ê°„ ê²°ì œì•¡ 20% í˜ì´ë°±')")
                st.write("  2ï¸âƒ£ UX ê°œì„  (ê²°ì œ í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ 50% ë‹¨ì¶• + 1-í´ë¦­ êµ¬ë…)")
                st.write("  3ï¸âƒ£ ì‹ ë¢° ë©”ì‹œì§• (ê²°ì œ ë‚´ì—­ íˆ¬ëª…ì„±, ì–¸ì œë“  ì¤‘ë‹¨ ê°€ëŠ¥ ê°•ì¡°)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ìë™ê²°ì œ ì „í™˜ìœ¨ 15% â†’ 42%, ë§¤ì›” ì”ì¡´ìœ¨ 8% í¬ì¸íŠ¸ ìƒìŠ¹")
            else:
                st.markdown("#### **[ê¸°ì¡´ ì „í™˜] ì›” êµ¬ë… â†’ ì—°ê°„ êµ¬ë… ëª¨ë¸ ì œì•ˆ**")
                st.write("- **ëª©í‘œ**: LTV ê·¹ëŒ€í™” ë° ì´íƒˆ ìœ„í—˜ ê°ì†Œ")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ìš”ê¸ˆì œ ì¬êµ¬ì„± (ì›” 9,900ì› â†’ ì—° 99,000ì›, 15% í• ì¸)")
                st.write("  2ï¸âƒ£ ë²ˆë“¤ ìƒí’ˆ (ì—°ê°„ê¶Œ + í”„ë¦¬ë¯¸ì—„ í˜œíƒ 3ê°€ì§€ íŒ¨í‚¤ì§€í™”)")
                st.write("  3ï¸âƒ£ ìë™ ê°±ì‹  ë¬´ë£Œ ì—°ì¥ (1ë…„ ì´ìƒ ìë™ê²°ì œ ì‹œ ë§¤ë…„ 1ì£¼ì¼ ë¬´ë£Œ)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ê²°ì œ ì£¼ê¸° 12ë°° ì—°ì¥, ì´íƒˆë¥  35% ê°ì†Œ")

        with t2:
            st.markdown("#### **2. ì‚¬ìš©ì í™œë™ì„± ë° ê²½í—˜ ê°•í™”**")
            st.write("**ë¶„ì„ ì¸ì‚¬ì´íŠ¸**: ì›” ì²­ì·¨ ì‹œê°„ì´ 50% ê°ì†Œí•˜ëŠ” ê³ ê°ì€ 3ì£¼ ë‚´ ì´íƒˆ í™•ë¥  70%")
            st.markdown("")
            
            if total_mins < 30:
                st.warning("#### **âš ï¸ [í™œì„±í™” í•„ìˆ˜] íœ´ë©´ ì‚¬ìš©ì ê¹¨ìš°ê¸°**")
                st.write("- **í˜„í™©**: ì¼ì¼ í‰ê·  ì²­ì·¨ ì‹œê°„ 30ë¶„ ë¯¸ë§Œ (ìœ„í—˜ ì‹ í˜¸)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ë§¥ë½ ê¸°ë°˜ í‘¸ì‹œ (ìê¸° ì§ì „, ì¶œí‡´ê·¼ ì‹œê°„ ë“± í™œë™ ì˜ˆìƒ ì‹œê°„ëŒ€ì— ì •í™•íˆ ë°œì†¡)")
                st.write("  2ï¸âƒ£ ì„ í˜¸ê³¡ ì‹ ê³¡ ì •ë³´ (êµ¬ë… ì¤‘ì¸ ì•„í‹°ìŠ¤íŠ¸ ì‹ ê³¡ ì¶œì‹œ ì¦‰ì‹œ ì•Œë¦¼)")
                st.write("  3ï¸âƒ£ ë„íŒŒë¯¼ íŠ¸ë¦¬ê±° (ì¼ì£¼ì¼ ì—°ì† ì²­ì·¨ ì‹œ ë°°ì§€, ì›” 10ì‹œê°„ ë„ë‹¬ ì‹œ í¬ì¸íŠ¸)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: í™œë™ì„± 70% ì¦ëŒ€, ì´íƒˆ ì‹œì  7ì¼ ì—°ì¥")
            elif total_mins < 180:
                st.markdown("#### **âœ… [ì‹¬í™”] ê³ ê´€ì—¬ì¸µìœ¼ë¡œì˜ ì—…ê·¸ë ˆì´ë“œ**")
                st.write("- **í˜„í™©**: ì•ˆì •ì  í™œë™ íŒ¨í„´ (ì›” 20~30ì‹œê°„)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ í”„ë¦¬ë¯¸ì—„ ìŒì§ˆ ê²½í—˜ (HD ìŒì§ˆ 3ì¼ ì²´í—˜ â†’ ì›”ì •ì•¡ +2,000ì› ì „í™˜)")
                st.write("  2ï¸âƒ£ íë ˆì´ì…˜ ì‹¬í™” (AI ê¸°ë°˜ 'ë‚´ ìŒì•…' ë§ì¶¤ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì£¼ 3íšŒ ì œê³µ)")
                st.write("  3ï¸âƒ£ íŒ¬ë¤ ì»¤ë®¤ë‹ˆí‹° (ì¢‹ì•„í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ íŒ¬í´ëŸ½ì— ìë™ ê°€ì…)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: í”„ë¦¬ë¯¸ì—„ ì „í™˜ìœ¨ 12% â†’ 28%, ì›” ì²­ì·¨ ì‹œê°„ 25% ì¦ê°€")
            else:
                st.success("#### **ğŸ”¥ [ìœ ì§€] ì¶©ì„± íŒ¬ì¸µ ê°•í™” ì „ëµ**")
                st.write("- **í˜„í™©**: ì›” 180ë¶„ ì´ìƒ ì²­ì·¨ (ìƒìœ„ 5% í—¤ë¹„ ìœ ì €)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ VIP ì „ìš© ì´ë²¤íŠ¸ (ì›” ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë°, ì•„í‹°ìŠ¤íŠ¸ ì¹œì ˆ Q&A)")
                st.write("  2ï¸âƒ£ íŒ¬ í¬ì¸íŠ¸ í”„ë¡œê·¸ë¨ (ë§¤ì›” ì²­ì·¨ì‹œê°„ ê¸°ë°˜ ì ë¦½, êµ¿ì¦ˆ/ì½˜ì„œíŠ¸í‘œ êµí™˜)")
                st.write("  3ï¸âƒ£ ê³µë™ ì œì‘ ê¸°íšŒ (í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íë ˆì´ì…˜, ì•¨ë²” ì»¤ë²„ íˆ¬í‘œ ê¶Œí•œ)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ì¬êµ¬ë…ìœ¨ 98% ìœ ì§€, ì›” í‰ê·  ì¶”ê°€ ê²°ì œ ë°œìƒ")

        with t3:
            st.markdown("#### **3. ì˜ˆë°©ì  ê´€ë¦¬ ë° ë¸Œëœë“œ ì†Œí†µ**")
            st.markdown("")
            
            if cancel_rate > 0.5:
                st.error("#### **ğŸš¨ [ê¸´ê¸‰ SOS] ì´íƒˆ ì§ì „ ê³ ê° ì§‘ì¤‘ êµ¬ì¶œ**")
                st.write("- **ìœ„í—˜ë„**: ğŸ”´ **CRITICAL** (ì´íƒˆ ê°€ëŠ¥ì„± 85% ì´ìƒ)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ì‹¤ì‹œê°„ ëŒ€ì‘ (í•´ì§€ í´ë¦­ ì‹œ ì¦‰ì‹œ 'êµ¬ë… ì¼ì‹œì •ì§€' ì˜µì…˜ íŒì—…)")
                st.write("  2ï¸âƒ£ 1:1 ìƒë‹´ (ìƒë‹´ì‚¬ ì§í†µ: ì‹¤ì‹œê°„ ì±„íŒ… + ì´ë©”ì¼, ìµœëŒ€ 3ì¼ ë‚´ ì‘ë‹µ)")
                st.write("  3ï¸âƒ£ ì¡°ê±´ë¶€ í˜œíƒ (í•œ ë‹¬ ë¬´ë£Œ + ìµœê·¼ ë¶ˆë§Œì‚¬í•­ 'êµ¬ì²´ì ' í•´ê²°ì±… ì œì‹œ)")
                st.write("  4ï¸âƒ£ íƒˆí‡´ ì¡°ì‚¬ (ì´íƒˆ ì‚¬ìœ  3ë¬¸ 10ì´ˆ ë¯¸ë‹ˆ ì„œë² ì´ë¡œ ê°œì„  ë°©í–¥ íŒŒì•…)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ì´íƒˆ ì €ì§€ìœ¨ 42%, ì¬ê°€ì…ìœ¨ 18%")
            elif cancel_rate > 0.2:
                st.warning("#### **âš ï¸ [ì˜ˆë°©] ë¶ˆë§Œ ê³ ê° ì„ ì œ ëŒ€ì‘**")
                st.write("- **ìœ„í—˜ë„**: ğŸŸ¡ **WARNING** (ì´íƒˆ ì´ë ¥ ìˆìœ¼ë‚˜ ì§„í–‰ ì¤‘)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ë§Œì¡±ë„ ë§ì¶¤ ì¡°ì‚¬ (ì£¼ 1íšŒ ê°„ë‹¨í•œ ê°ì • í”¼ë“œë°±: ğŸ˜ŠğŸ˜ğŸ˜)")
                st.write("  2ï¸âƒ£ í”„ë¡œì•¡í‹°ë¸Œ ì§€ì› (ë¶ˆë§Œ í‚¤ì›Œë“œ ê°ì§€ ì‹œ ìë™ ì§€ì›íŒ€ ë°°ì •)")
                st.write("  3ï¸âƒ£ ê°œì„  ê³µê°œ (ê³ ê°ì˜ í”¼ë“œë°± â†’ ì„œë¹„ìŠ¤ ê°œì„  â†’ ê°ì‚¬ í”¼ë“œë°±)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ë¶ˆë§Œ ì¬ë°œë¥  40% ê°ì†Œ, ì‹ ë¢°ë„ 3í¬ì¸íŠ¸ ì¦ê°€")
            else:
                st.success("#### **ğŸ’ [ì‹¬í™”] ë¸Œëœë“œ ì• í˜¸ê°€ í”„ë¡œê·¸ë¨**")
                st.write("- **ë§Œì¡±ë„**: ğŸŸ¢ **STABLE** (ì¶©ì„± ê³ ê° ë‹¨ê³„)")
                st.write("- **ì „ëµ**:")
                st.write("  1ï¸âƒ£ ë¸Œëœë“œ ì„œí¬í„°ì¦ˆ ì–‘ì„± (SNS í™œë™, ë¦¬ë·° ì‘ì„± ì‹œ ì›” í¬ì¸íŠ¸ ì ë¦½)")
                st.write("  2ï¸âƒ£ ì„œë¹„ìŠ¤ ê°œì„  ì„¤ë¬¸ ì°¸ì—¬ (ë¶„ê¸°ë³„ ë¹… ê²°ì •ì— íˆ¬í‘œê¶Œ ë¶€ì—¬, ì±„íƒ ì‹œ ë³´ìƒ)")
                st.write("  3ï¸âƒ£ ì»¤ë®¤ë‹ˆí‹° ë¦¬ë” ê¸°íšŒ (ë¸”ë¡œê·¸, ìœ íŠœë¸Œ í˜‘ë ¥, ì œíœ´ ìˆ˜ìµ ë°°ë¶„)")
                st.write("- **ì˜ˆìƒ íš¨ê³¼**: ì¬êµ¬ë…ìœ¨ 96% ì´ìƒ ìœ ì§€, ì…ì†Œë¬¸ íš¨ê³¼ë¡œ ì‹ ê·œ ì´íƒˆë¥  15% ê°ì†Œ")

        with t4:
            st.markdown("#### **4. ì˜ˆìƒ ì‹¤í–‰ íš¨ê³¼ ë° ROI**")
            st.markdown("")
            
            # ì‹œë‚˜ë¦¬ì˜¤ë³„ íš¨ê³¼ ê³„ì‚°
            if txn_cnt <= 3 and cancel_rate < 0.2:
                # ì‹ ê·œ ìœ ì € ì‹œë‚˜ë¦¬ì˜¤
                st.write("**ğŸ“Š ì‹ ê·œ ê³ ê°(ì´ˆê¸° 1-3ê°œì›”) ê¸°ëŒ€ íš¨ê³¼:**")
                st.write("| ì§€í‘œ | ê°œì… ì „ | ê°œì… í›„ | ê°œì„  |")
                st.write("|------|--------|--------|------|")
                st.write("| ì¬ê²°ì œìœ¨ | 35% | 68% | **+33%p** |")
                st.write("| ì´íƒˆë¥  | 50% | 25% | **-25%p** |")
                st.write("| í‰ê·  ìƒì¡´ ê¸°ê°„ | 8ê°œì›” | 14ê°œì›” | **+75%** |")
                st.write("| ê°œì…ë‹¹ ë¹„ìš© | - | ~2,000ì› | - |")
                st.write("| **ì˜ˆìƒ ìˆ˜ìµì„±** | - | - | **1ì¸ë‹¹ +18ë§Œì›** |")
                
            elif cancel_rate > 0.5:
                # ê³ ìœ„í—˜ ê³ ê° ì‹œë‚˜ë¦¬ì˜¤
                st.write("**ğŸš¨ ê³ ìœ„í—˜ ê³ ê°(ê¸´ê¸‰ ëŒ€ì‘) ê¸°ëŒ€ íš¨ê³¼:**")
                st.write("| ì§€í‘œ | ê°œì… ì „ | ê°œì… í›„ | ê°œì„  |")
                st.write("|------|--------|--------|------|")
                st.write("| ì´íƒˆ ì €ì§€ìœ¨ | 0% | 42% | **+42%p** |")
                st.write("| ì¬ê°€ì…ìœ¨ | 8% | 18% | **+10%p** |")
                st.write("| ìˆœì†ìµ (ê°œì… ë¹„ìš© ì œì™¸) | -30ë§Œì› | +12ë§Œì› | **+42ë§Œì›** |")
                st.write("| ê°œì…ë‹¹ ë¹„ìš© | - | ~5,000ì› | - |")
                st.write("| **ì˜ˆìƒ ìˆœìˆ˜ìµ** | - | - | **1ì¸ë‹¹ +11ë§Œì›** |")
                
            else:
                # ì¼ë°˜ ê³ ê° ì‹œë‚˜ë¦¬ì˜¤
                st.write("**ğŸ“ˆ ì¼ë°˜ ê³ ê°(ì§€ì† ê´€ë¦¬) ê¸°ëŒ€ íš¨ê³¼:**")
                st.write("| ì§€í‘œ | ê°œì… ì „ | ê°œì… í›„ | ê°œì„  |")
                st.write("|------|--------|--------|------|")
                st.write("| ì›” ì²´ë¥˜ìœ¨ | 88% | 94% | **+6%p** |")
                st.write("| ì›” í™œë™ì„± | 20ì‹œê°„ | 26ì‹œê°„ | **+30%** |")
                st.write("| í‰ê·  ê²°ì œì•¡ | 9,900ì› | 12,400ì› | **+25%** |")
                st.write("| ê°œì…ë‹¹ ë¹„ìš© | - | ~500ì› | - |")
                st.write("| **ì˜ˆìƒ ìˆ˜ìµì„±** | - | - | **1ì¸ë‹¹ +3.5ë§Œì›/ì›”** |")
            
            st.markdown("")
            st.info("""
            **ğŸ’¡ í•µì‹¬ ì „ëµ:**
            - **ì‹ ê·œ/ê³ ìœ„í—˜**: ê³µê²©ì  ê°œì…ì´ ROI ìµœê³  (50~100% ë‹¨ê¸° íš¨ê³¼)
            - **ì¼ë°˜ ê³ ê°**: ì§€ì†ì  ê´€ë¦¬ë¡œ ì¥ê¸° LTV ê·¹ëŒ€í™” (50% ì´ìƒ í–¥ìƒ)
            - **VIP**: ê°€ì¥ ë†’ì€ ìœ ì§€ìœ¨ í•„ìš” (1ëª…ì˜ VIP = ì‹ ê·œ 5ëª…)
            
            **âš¡ ë¹ ë¥¸ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
            1. [ ] ì˜¤ëŠ˜: ê³ ìœ„í—˜ ê³ ê° 1:1 ìƒë‹´íŒ€ ë°°ì •
            2. [ ] ì´ë²ˆì£¼: ìë™ê²°ì œ UX ê°œì„  + 20% í˜ì´ë°± ì¹´í”¼ ì¤€ë¹„
            3. [ ] ë‹¤ìŒì£¼: ì‹ ê·œ ì˜¨ë³´ë”© ë³´ë„ˆìŠ¤ í™œì„±í™”
            4. [ ] 1ê°œì›” í›„: íš¨ê³¼ ì¸¡ì • & í”¼ë“œë°± ë°˜ì˜
            """)

        st.markdown("---")

    st.markdown("---")
    st.caption("KeepTune v2.6 | Enterprise AI Decision Support System Operating")

if __name__ == "__main__":
    run_predict()